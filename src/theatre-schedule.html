<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<dom-module id="theatre-schedule">

  <template>

    <style is="custom-style">
      :host {
        display: block;
        padding: 10px;
      }

      iron-list {
        padding-bottom: 16px;
      }

      .item {
        @apply(--layout-horizontal);
        padding: 20px;
        border-radius: 8px;
        background-color: white;
        border: 1px solid #ddd;
        max-width: 800px;
        margin: 16px auto 0;
      }

      .item:focus {
        outline: 0;
        border-color: var(--app-primary-color);
      }

      .pad {
        padding: 0 16px;
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }

      .primary {
        font-size: 16px;
        font-weight: bold;
        color: var(--app-secondary-color);
        text-decoration: none;
      }

      a {
        text-decoration: none;
      }

      paper-input {
        --paper-input-container-focus-color: var(--app-primary-color);
        max-width: 840px;
        margin: 0 auto 0;
      }

      .more {
        display: none;
      }

      .item.expanded .more {
        display: block;
      }


    </style>


    <iron-ajax url="http://www.finnkino.fi/xml/Schedule/" last-response="{{xmlData}}" auto handle-as="xml" id="ajax" params="{{getParameters}}"></iron-ajax>

    <iron-list items="[[filteredShows]]" as="item" id="ironList" selection-enabled multi-selection>
      <template>
        <div>
          <div class$="[[getClassForItem(item, selected)]]" tabindex$="[[tabIndex]]">
            <div class="pad">
              <div class="primary">[[item.OriginalTitle]]</div>
              <div class="more">sadsdadsadsa</div>
            </div>
          </div>
        </div>
      </template>
    </iron-list>

  </template>

  <script>
    Polymer({

      is: 'theatre-schedule',

      properties: {
        theatreId: {
          type: String
        },
        xmlData: {
          observer: 'xmlDataChanged'
        },
        getParameters: {
          type: Object
        },
        routeData: {
          type: Object,
          observer: 'routeChanged'
        },
        shows: {
          type: Object
        },
        filteredShows: {
          type: Object
        }
      },

      routeChanged: function() {
        if (this.routeData.prefix === '/theatre-schedule' && this.routeData.path !== '') {
          this.theatreId = this.routeData.path.substring(1);
          this.fetchSchedule()
        }
      },

      fetchSchedule: function() {
        this.getParameters = {
          area: this.theatreId
        }
      },

      xmlDataChanged: function() {
        this.filteredShows = this.shows = this.xml2json(this.xmlData).Schedule.Shows.Show;
        this.$.ironList.notifyResize();
      },

      getClassForItem: function(item, selected) {
          return selected ? 'item expanded' : 'item';
      },

      xml2json: function(xml) {
        try {
          var obj = {};
          if (xml.children.length > 0) {
            for (var i = 0; i < xml.children.length; i++) {
              var item = xml.children.item(i);
              var nodeName = item.nodeName;

              if (typeof(obj[nodeName]) == "undefined") {
                obj[nodeName] = this.xml2json(item);
              } else {
                if (typeof(obj[nodeName].push) == "undefined") {
                  var old = obj[nodeName];

                  obj[nodeName] = [];
                  obj[nodeName].push(old);
                }
                obj[nodeName].push(this.xml2json(item));
              }
            }
          } else {
            obj = xml.textContent;
          }
          return obj;
        } catch (e) {
          console.log(e.message);
        }
      }

    });
  </script>

</dom-module>
