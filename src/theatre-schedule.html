<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<dom-module id="theatre-schedule">

  <template>

    <style is="custom-style">
      :host {
        display: block;
        padding: 10px;
      }

      .item {
        @apply(--layout-horizontal);
        padding: 20px;
        border-radius: 8px;
        background-color: white;
        border: 1px solid #ddd;
        max-width: 800px;
        margin: 16px auto 0;
      }

      .item:focus {
        outline: 0;
        border-color: var(--app-primary-color);
      }

      .pad {
        padding: 0 16px;
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }

      .primary {
        font-size: 16px;
        font-weight: bold;
        color: var(--app-secondary-color);
        text-decoration: none;
      }

      a {
        text-decoration: none;
      }

      paper-input {
        --paper-input-container-focus-color: var(--app-primary-color);
        max-width: 840px;
        margin: 0 auto 0;
      }

      .more {
        display: none;
      }

      .item.expanded .more {
        display: block;
      }

      .more-icon {
        display: inline-block;
        --paper-fab-background: var(--app-primary-color);
      }

      .inherit {
        color: inherit;
        background-color: inherit;
      }

      paper-progress {
        --paper-progress-active-color: var(--app-primary-color);
        width: 100%;
      }

      .hide {
        display: none;
      }

      .buy-icon {
        display: inline-block;
        float: right;
        --paper-fab-background: var(--paper-green-500);
      }

      .filters {
        max-height: 100px;
        transition-property: all;
        transition-duration: .5s;
        transition-timing-function: cubic-bezier(0, 1, 0.5, 1);
        overflow-y: hidden;
      }

      .filters.closed {
        max-height: 0;
      }

      .filter-fab {
        --paper-fab-background: var(--app-primary-color);
        position: fixed;
        bottom: 16px;
        right: 16px;
      }

      .close-toast-button {
        text-transform: none;
        color: var(--app-primary-color);
      }

      .filters-list {
        padding-left: 8px;
        padding-right: 8px;
      }

      vaadin-date-picker {
        --primary-color: var(--app-primary-color);
      }

      app-toolbar {
        background-color: var(--app-primary-color);
      }

      .title {
        color: white;
      }

      .back-button {
        color: white;
      }
    </style>


    <iron-ajax url="https://www.finnkino.fi/xml/Schedule/" last-response="{{xmlData}}" auto handle-as="xml" id="ajax" params="{{getParameters}}"></iron-ajax>
    <paper-progress indeterminate class$="[[showLoading(scheduleFetched)]]"></paper-progress>

    <template is="dom-repeat" items="{{filteredShows}}" id="showsTemplate">
      <div>
        <div class$="{{getClassForItem(item)}}" tabindex$="[[tabIndex]]">
          <div class="pad">
            <div class="primary">
              <paper-fab mini icon="{{getIconForItem(item)}}" index="{{index}}" title="More" class="more-icon" on-tap="moreIconTapped"></paper-fab>
              [[getTimeForItem(item.dttmShowStartUTC)]] {{item.OriginalTitle}}
            </div>
            <div class="more">
              <a href="{{item.ShowURL}}" class="inherit">
                <paper-fab mini icon="add-shopping-cart" title="heart" class="buy-icon"></paper-fab>
              </a>
            </div>
          </div>
        </div>
      </div>
    </template>

    <paper-fab icon="icons:filter-list" title="Filters" on-tap="toggleFilters" class="filter-fab"></paper-fab>

    <app-drawer id="filtersDrawer" align="start">
      <app-toolbar>
        <a href="/" class="back-button">
          <paper-icon-button icon="arrow-back"></paper-icon-button>
        </a>
        <div title class="title">Finnkino Movies</div>
      </app-toolbar>
      <div class="filters-list">
        <paper-input label="Search" value="{{filterValue}}" on-keyup="filterList" id="searchFilter"></paper-input>
        <vaadin-date-picker value="{{filters.date}}" label="Date" id="datePicker"></vaadin-date-picker>
        <paper-button on-tap="toggleFilters" class="close-toast-button">Hide</paper-button>
      </div>
    </app-drawer>
    <paper-toast text="Loading..." id="loadingToast"></paper-toast>
    <paper-toast text="Movies updated" id="updatedToast"></paper-toast>
    <paper-toast text="No movies found" id="notFoundToast"></paper-toast>

  </template>

  <script>
    Polymer({

      is: 'theatre-schedule',

      properties: {
        theatreId: {
          type: String
        },
        xmlData: {
          observer: 'xmlDataChanged'
        },
        getParameters: {
          type: Object
        },
        routeData: {
          type: Object,
          observer: 'routeChanged'
        },
        shows: {
          type: Object
        },
        filteredShows: {
          type: Object
        },
        scheduleFetched: {
          type: Boolean,
          value: false
        },
        showFilters: {
          type: Boolean,
          value: true
        },
        filters: {
          type: Object,
          value: function() {
            var today = new Date();
            return {
              'date': today.toISOString().split('T')[0]
            }
          }
        }
      },

      attached: function() {
        this.addDateEventListener();
      },

      addDateEventListener: function() {
        this.$.datePicker.addEventListener('value-changed', function() {
          this.scheduleFetched = false;
          this.fetchSchedule();
        }.bind(this));
      },

      routeChanged: function() {
        if (this.routeData.prefix === '/theatre-schedule' && this.routeData.path !== '') {
          this.clearFilters();
          this.theatreId = this.routeData.path.substring(1);
          this.scheduleFetched = false;
          this.clearSchedule();
          this.fetchSchedule();
        }
      },

      showLoading: function(scheduleFetched) {
        return scheduleFetched ? 'hide' : '';
      },

      filterList: function() {
        if (this.filterValue.trim() == '') {
          this.setFilteredShows(this.shows);
        } else {
          var filteredList = [];
          this.shows.forEach(function(value) {
            if (value.OriginalTitle.toLowerCase().indexOf(this.filterValue.toLowerCase()) > -1) {
              filteredList.push(value);
            }
          }.bind(this));
          this.setFilteredShows(filteredList);
        }
      },

      setFilteredShows(shows) {
        this.filteredShows = shows;
      },

      clearSchedule: function() {
        this.filteredShows = this.shows = [];
      },

      fetchSchedule: function() {
        this.$.loadingToast.show();
        this.async(function() {

          var dateArray = this.filters.date.split('-');
          var date = [dateArray[2], dateArray[1], dateArray[0]].join('.')
          this.getParameters = {
            area: this.theatreId,
            dt: date
          }
        });
      },

      xmlDataChanged: function() {
        var shows = this.xml2json(this.xmlData).Schedule.Shows.Show;
        if (shows) {
          this.$.updatedToast.open();
          this.filteredShows = this.shows = this.filterFutureShows(shows);
          this.filterList();
        } else {
          this.filteredShows = this.shows = [];
          this.$.notFoundToast.open();
        }
        setTimeout(function() {
          this.scheduleFetched = true;
        }.bind(this), 1);
      },

      filterFutureShows: function(shows) {
        var now = new Date();
        var filteredShows = [];
        shows.forEach(function(value) {
          var showTime = new Date(value.dttmShowStartUTC);
          if (showTime.getTime() > now.getTime()) {
            filteredShows.push(value);
          }
        });
        return filteredShows;
      },

      getClassForItem: function(item) {
        return item.selected ? 'item expanded' : 'item';
      },

      getIconForItem: function(item) {
        return item.selected ? 'expand-less' : 'expand-more';
      },

      getTimeForItem: function(dttmShowStartUTC) {
        var date = new Date(dttmShowStartUTC);
        var dateString = date.toISOString().split('T')[0];
        var time = date.getHours() + ':' + (('' + date.getMinutes()).length === 1 ? date.getMinutes() + '0' : date.getMinutes());
        return [dateString, time].join(' ');
      },

      expandMore: function() {

      },

      expandLess: function() {

      },

      xml2json: function(xml) {
        try {
          var obj = {};
          if (xml.children.length > 0) {
            for (var i = 0; i < xml.children.length; i++) {
              var item = xml.children.item(i);
              var nodeName = item.nodeName;

              if (typeof(obj[nodeName]) == "undefined") {
                obj[nodeName] = this.xml2json(item);
              } else {
                if (typeof(obj[nodeName].push) == "undefined") {
                  var old = obj[nodeName];

                  obj[nodeName] = [];
                  obj[nodeName].push(old);
                }
                obj[nodeName].push(this.xml2json(item));
              }
            }
          } else {
            obj = xml.textContent;
          }
          return obj;
        } catch (e) {
          console.log(e.message);
        }
      },

      toggleFilters: function() {
        this.$.filtersDrawer.opened ? this.closeFilters() : this.openFilters();
      },

      closeFilters: function() {
        this.$.filtersDrawer.close();
      },

      openFilters: function() {
        this.$.filtersDrawer.open();
      },

      clearFilters: function() {
        this.filterValue = '';
        this.filterList();
        this.closeFilters();
      },

      moreIconTapped: function(e) {
        var fab = e.target;
        var index = fab.index;
        this.filteredShows[index].selected = !this.filteredShows[index].selected;
        var item = e.target.parentNode.parentNode.parentNode;
        if (this.filteredShows[index].selected) {
          item.classList.add("expanded");
          fab.icon = 'expand-less'
        } else {
          item.classList.remove("expanded");
          fab.icon = 'expand-more'
        }
      }

    });
  </script>

</dom-module>
